# ==============================================
# Qwen Image Service - Docker Compose
# ==============================================

services:
  qwen-image:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: qwen-image-service
    user: root
    restart: unless-stopped
    
    # GPU支持
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["2"]
              capabilities: [gpu]
    
    ports:
      - "8200:8000"
    
    volumes:
      # 本地模型目录挂载
      - ./models:/app/models
      # HuggingFace缓存持久化（在线下载模型时使用）
      - huggingface_cache:/home/appuser/.cache/huggingface
      # 配置文件挂载（可选，方便修改配置）
      - ./config:/app/config:ro
      # 日志目录（可选）
      - ./logs:/app/logs
      # 数据目录（SQLite数据库持久化）
      - ./data:/app/data
    
    environment:
      # 服务配置
      - APP_HOST=0.0.0.0
      - APP_PORT=8000
      - APP_DEBUG=false

      # 禁用Intel XPU检测（解决torch.xpu错误）
      - ACCELERATE_TORCH_DEVICE=cuda
      - PYTORCH_ENABLE_MPS_FALLBACK=0
      # 显存优化
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
      
      # 模型配置
      # 使用HuggingFace在线模型：
      #- TEXT_TO_IMAGE_MODEL=Qwen/Qwen-Image-2512
      #- IMAGE_EDIT_MODEL=Qwen/Qwen-Image-Edit-2511
      # 或使用本地模型路径（取消注释）：
      - TEXT_TO_IMAGE_MODEL=/app/models/Qwen-Image-2512
      - IMAGE_EDIT_MODEL=/app/models/Qwen-Image-Edit-2511
      - MODELS_DIR=/app/models
      - DEVICE=cuda
      
      # HuggingFace配置（可选，如果需要私有模型）
      # - HF_TOKEN=your_token_here
      # 使用HuggingFace镜像（国内加速）
      - HF_ENDPOINT=https://hf-mirror.com
      
      # 日志配置
      - LOG_LEVEL=INFO
      - LOG_FILE_ENABLED=true
      - LOG_FILE_PATH=/app/logs/app.log
      
      # 安全配置
      - MAX_UPLOAD_SIZE_MB=20
      # 生产环境请修改CORS_ORIGINS
      #- CORS_ORIGINS=["*"]
      - CORS_ORIGINS=["*"]
      
      # 临时文件清理
      - AUTO_CLEANUP_ENABLED=true
      - TEMP_FILE_MAX_AGE_HOURS=24
      
      # 用户认证配置
      - AUTH_ENABLED=true
      # 生产环境请修改为随机字符串！
      - AUTH_SECRET_KEY=your-secret-key-change-in-production-please
      # Token 过期时间（分钟），默认 24 小时
      - AUTH_TOKEN_EXPIRE_MINUTES=1440
      # 默认管理员账号（首次启动自动创建）
      - AUTH_DEFAULT_ADMIN_USERNAME=admin
      - AUTH_DEFAULT_ADMIN_PASSWORD=admin123
      # 是否允许用户自行注册
      - AUTH_ALLOW_REGISTRATION=true
      
      # 配额限制配置
      - QUOTA_ENABLED=true
      # 默认每日限额（生成几张图消耗几次）
      - QUOTA_DEFAULT_DAILY_LIMIT=100
      # 默认每月限额
      - QUOTA_DEFAULT_MONTHLY_LIMIT=3000
      # 管理员是否不受配额限制
      - QUOTA_ADMIN_UNLIMITED=true
      
      # 存储配置（图片持久化）
      # 输出目录（会保存到 ./data/outputs）
      - STORAGE_OUTPUT_DIR=/app/data/outputs
      # 是否按日期组织目录（年/月/日）
      - STORAGE_ORGANIZE_BY_DATE=true
      # 是否按用户ID组织目录
      - STORAGE_ORGANIZE_BY_USER=true
      # 文件保留天数（0表示永久保留）
      - STORAGE_RETENTION_DAYS=0
    
    # 健康检查
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # 模型加载需要时间

  # 前端服务
  qwen-image-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: qwen-image-frontend
    restart: unless-stopped
    ports:
      - "8000:80"
    depends_on:
      - qwen-image
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3

# 持久化卷
volumes:
  huggingface_cache:
    driver: local

# 网络配置（可选）
networks:
  default:
    name: qwen-image-network